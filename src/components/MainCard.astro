---
import { t } from "@config";
import { Icon } from "astro-icon/components";
import Card from "@/components/temple/Card.astro";
import { Image } from "astro:assets";
import type { PostData } from "@interfaces/data";

export interface MainCardProps extends PostData {
  infoIcon?: string; // Icon for the info button
  helpText?: string; // Custom help text (defaults to "Learn More")
  textOverlay?: string; // Text to overlay on background when no image
  showTextBackground?: boolean; // Show text background when no image
  headerClass?: string; // Additional classes for the header
  extraClasses?: string; // Additional classes for the whole card
}

const {
  title,
  description,
  image,
  infoIcon = "lucide:help-circle",
  helpText = t("label.learnMore"),
  textOverlay,
  showTextBackground = true,
  headerClass = "",
  extraClasses = "",
} = Astro.props as MainCardProps;

// Create a more descriptive label for the button
const accessibleHelpText = `${helpText}: ${title}`;
---

<Card class={`overflow-hidden ${extraClasses}`}>
  {
    image ? (
      // With image - show image with overlay title
      <div class="relative hero-banner-wrapper">
        <div class="aspect-video w-full overflow-hidden bg-base-300">
          <Image
            src={image}
            alt={title}
            width={1200}
            height={630}
            format="webp"
            loading="eager"
            class="w-full h-full object-contain hero-banner-image"
          />
        </div>

        {/* Flex container for Title and Button */}
        <div class="absolute bottom-4 left-4 right-4 lg:bottom-6 lg:left-6 lg:right-6 flex items-end justify-between gap-4">
          {/* Title */}
          <div class="inline-block bg-black/60 backdrop-blur-md px-4 py-2 rounded-xl border border-white/40 shadow-lg">
            <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold text-white">{title}</h1>
          </div>

          {/* Description Button */}
          {description && (
            <div class="flex-shrink-0">
              <div class="dropdown dropdown-top dropdown-end dropdown-hover">
                <label
                  tabindex="0"
                  aria-label={accessibleHelpText}
                  class="group btn btn-sm px-2 bg-black/60 backdrop-blur-md hover:bg-black/80 border border-white/40 text-white shadow-lg rounded-full flex items-center gap-0 transition-all duration-300 ease-in-out"
                >
                  <Icon name={infoIcon} class="w-4 h-4 flex-shrink-0" />
                  <span class="w-0 overflow-hidden group-hover:w-20 transition-all duration-300 text-xs whitespace-nowrap">
                    {helpText}
                  </span>
                </label>
                <div
                  tabindex="0"
                  class="dropdown-content z-[1] card w-64 sm:w-80 p-2 shadow-lg bg-black/70 backdrop-blur-md text-white border border-white/20 mb-4"
                  data-state="closed"
                >
                  <div class="card-body p-3">
                    <p class="text-sm">{description}</p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    ) : textOverlay ? (
      // No image, but with textOverlay - show gradient background with overlay text
      <div class="relative">
        <div class={`aspect-video w-full overflow-hidden bg-gradient-to-br from-base-300 to-base-100 ${headerClass}`}>
          {showTextBackground && textOverlay && (
            <div class="absolute inset-0 w-full h-full error-animation-container">
              <div class="text-9xl md:text-[12rem] font-bold text-primary opacity-20 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                {textOverlay}
              </div>
            </div>
          )}
        </div>

        {/* Flex container for Title and Button */}
        <div class="absolute bottom-4 left-4 right-4 lg:bottom-6 lg:left-6 lg:right-6 flex items-end justify-between gap-4">
          {/* Title */}
          <div class="inline-block bg-black/60 backdrop-blur-md px-4 py-2 rounded-xl border border-white/40 shadow-lg">
            <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold text-white">{title}</h1>
          </div>

          {/* Description Button */}
          {description && (
            <div class="flex-shrink-0">
              <div class="dropdown dropdown-top dropdown-end dropdown-hover">
                <label
                  tabindex="0"
                  aria-label={accessibleHelpText}
                  class="group btn btn-sm px-2 bg-black/60 backdrop-blur-md hover:bg-black/80 border border-white/40 text-white shadow-lg rounded-full flex items-center gap-0 transition-all duration-300 ease-in-out"
                >
                  <Icon name={infoIcon} class="w-4 h-4 flex-shrink-0" />
                  <span class="w-0 overflow-hidden group-hover:w-20 transition-all duration-300 text-xs whitespace-nowrap">
                    {helpText}
                  </span>
                </label>
                <div
                  tabindex="0"
                  class="dropdown-content z-[1] card w-64 sm:w-80 p-2 shadow-lg bg-black/70 backdrop-blur-md text-white border border-white/20 mb-4"
                  data-state="closed"
                >
                  <div class="card-body p-3">
                    <p class="text-sm">{description}</p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    ) : (
      // No image, no textOverlay - show simple title and description at top
      <div class="pt-6 px-6">
        <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold">{title}</h1>
        {description && <p class="mt-2 text-sm text-base-content/80">{description}</p>}
      </div>
    )
  }

  <!-- Content section -->
  <div class="p-4 sm:p-6">
    <slot />
  </div>
</Card>

<script>
  document.addEventListener("astro:page-load", () => {
    // Get all info buttons and dropdown contents
    const infoButtons = document.querySelectorAll(".dropdown label");
    const dropdownContents = document.querySelectorAll(".dropdown-content");

    // Add click event listeners
    infoButtons.forEach((button, index) => {
      button.addEventListener("click", () => {
        const content = dropdownContents[index];
        const currentState = content.getAttribute("data-state");

        // Toggle state
        if (currentState === "closed") {
          content.setAttribute("data-state", "open");
          // Add animation classes when opening
          content.classList.add("scale-100", "opacity-100");
          content.classList.remove("scale-90", "opacity-0");
        } else {
          content.setAttribute("data-state", "closed");
          // Remove animation classes when closing
          content.classList.add("scale-90", "opacity-0");
          content.classList.remove("scale-100", "opacity-100");
        }
      });
    });
  });
</script>

<style>
  /* ============================================
     ğŸŒ™ å°é¸Ÿæ¸¸å…­èŠ±é£æ ¼ - é‚ªç‹çœŸçœ¼Â·æš—å¤œç»“ç•Œ
     å…³é”®è¯ï¼šå†·é…·ä¸­äºŒã€ä»ªå¼æ„Ÿã€å­¤ç‹¬å€”å¼ºã€æš—å¤œéœ“è™¹
     ============================================ */
  
  .hero-banner-wrapper {
    position: relative;
    overflow: hidden;
  }

  /* å…­èŠ±ï¼šæš—å¤œé™ä¸´ + å…‹åˆ¶ç™»åœº */
  :global(.hero-cool-anime) .hero-banner-wrapper {
    background: radial-gradient(ellipse at center, rgba(20, 20, 50, 0.4) 0%, rgba(0, 0, 0, 0.9) 100%);
  }

  :global(.hero-cool-anime) .hero-banner-image {
    animation: rikka-awaken 2.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    filter: brightness(0.75) contrast(1.15) saturate(0.9);
    will-change: transform, filter;
    transition: filter 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* é‚ªç‹çœŸçœ¼è§‰é†’åŠ¨ç”» - ä»æš—åˆ°å¾®äº® */
  @keyframes rikka-awaken {
    0% {
      transform: scale(1.15);
      opacity: 0;
      filter: brightness(0.2) contrast(1.3) blur(10px);
    }
    50% {
      filter: brightness(0.5) contrast(1.2) blur(3px);
    }
    100% {
      transform: scale(1);
      opacity: 1;
      filter: brightness(0.75) contrast(1.15) blur(0);
    }
  }

  /* æ‚¬åœï¼šæå…¶å…‹åˆ¶çš„é™é»˜è„‰åŠ¨ */
  :global(.hero-cool-anime) .hero-banner-wrapper:hover .hero-banner-image {
    filter: brightness(0.88) contrast(1.2) saturate(1.1);
    transform: scale(1.005);
  }

  /* å†·è‰²éœ“è™¹ç»“ç•Œå…‰ - ä¸€æ¬¡æ€§ç¼“æ…¢æ‰«è¿‡ */
  :global(.hero-cool-anime) .hero-banner-wrapper::after {
    content: '';
    position: absolute;
    top: -10%;
    left: -120%;
    width: 70%;
    height: 120%;
    background: linear-gradient(
      95deg,
      transparent 0%,
      rgba(67, 56, 202, 0.12) 25%,
      rgba(109, 40, 217, 0.2) 45%,
      rgba(147, 51, 234, 0.25) 50%,
      rgba(109, 40, 217, 0.2) 55%,
      rgba(67, 56, 202, 0.12) 75%,
      transparent 100%
    );
    animation: rikka-barrier-scan 4s cubic-bezier(0.16, 1, 0.3, 1) 1.2s 1;
    pointer-events: none;
    transform: skewX(-8deg);
    z-index: 2;
    mix-blend-mode: screen;
  }

  @keyframes rikka-barrier-scan {
    0% {
      left: -120%;
      opacity: 0;
    }
    15% {
      opacity: 0.8;
    }
    85% {
      opacity: 0.6;
    }
    100% {
      left: 140%;
      opacity: 0;
    }
  }

  /* æ ‡é¢˜å’’è¯­æµ®ç° */
  :global(.hero-cool-anime) .hero-banner-wrapper .absolute {
    animation: rikka-spell-appear 2s cubic-bezier(0.16, 1, 0.3, 1) 1.5s both;
  }

  @keyframes rikka-spell-appear {
    0% {
      opacity: 0;
      transform: translateY(25px);
      filter: blur(6px);
    }
    70% {
      filter: blur(1px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
    }
  }

  /* æš—å¤œç»“ç•Œå¾®å…‰ - æ‚¬åœæ—¶æ‰æ˜¾ç° */
  :global(.hero-cool-anime) .hero-banner-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
      radial-gradient(ellipse at 25% 30%, rgba(109, 40, 217, 0.04) 0%, transparent 50%),
      radial-gradient(ellipse at 75% 70%, rgba(67, 56, 202, 0.03) 0%, transparent 50%);
    opacity: 0;
    animation: rikka-ambient-glow 10s ease-in-out infinite;
    pointer-events: none;
    z-index: 1;
  }

  :global(.hero-cool-anime) .hero-banner-wrapper:hover::before {
    opacity: 1;
    transition: opacity 1.5s ease-out;
  }

  @keyframes rikka-ambient-glow {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.7; }
  }

  /* ============================================
     â˜€ï¸ æ¡å´åƒæ£˜é£æ ¼ - å‚²å¨‡å¤§å°å§Â·é˜³å…‰ç‚¸è£‚
     å…³é”®è¯ï¼šå¼ºåŠ¿æ˜äº®ã€æ´»åŠ›è·ƒåŠ¨ã€ç”œé…·åå·®ã€ä¸»è§’å…‰ç¯
     ============================================ */

  .hero-cute-anime .hero-banner-wrapper {
    background: radial-gradient(ellipse at 50% 20%, rgba(255, 237, 213, 0.2) 0%, transparent 70%);
  }

  :global(.hero-cute-anime) .hero-banner-image {
    animation: chitoge-burst-in 1.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    filter: brightness(1.08) contrast(1.12) saturate(1.2);
    will-change: transform, filter;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* ç‚¸è£‚ç™»åœº - å¼ºåŠ¿å†²å‡» */
  @keyframes chitoge-burst-in {
    0% {
      transform: scale(0.85) translateY(20px);
      opacity: 0;
      filter: brightness(1.4) blur(8px);
    }
    40% {
      filter: brightness(1.2) blur(3px);
    }
    70% {
      transform: scale(1.02) translateY(-2px);
    }
    100% {
      transform: scale(1) translateY(0);
      opacity: 1;
      filter: brightness(1.08) blur(0);
    }
  }

  /* æ‚¬åœï¼šæ´»åŠ›è·ƒåŠ¨ */
  :global(.hero-cute-anime) .hero-banner-wrapper:hover .hero-banner-image {
    filter: brightness(1.15) contrast(1.15) saturate(1.25);
    transform: scale(1.04) translateY(-4px);
  }

  /* é‡‘è‰²é”åˆ©å…‰æŸ - å¿«é€Ÿå¼ºåŠ¿æ‰«è¿‡ */
  :global(.hero-cute-anime) .hero-banner-wrapper::after {
    content: '';
    position: absolute;
    top: -25%;
    left: -180%;
    width: 120%;
    height: 150%;
    background: linear-gradient(
      85deg,
      transparent 0%,
      rgba(245, 158, 11, 0.25) 25%,
      rgba(251, 191, 36, 0.4) 40%,
      rgba(252, 211, 77, 0.5) 50%,
      rgba(251, 191, 36, 0.4) 60%,
      rgba(245, 158, 11, 0.25) 75%,
      transparent 100%
    );
    animation: chitoge-shine-strike 2s cubic-bezier(0.4, 0, 0.2, 1) 0.5s 1;
    pointer-events: none;
    transform: skewX(-25deg);
    z-index: 2;
    mix-blend-mode: overlay;
  }

  @keyframes chitoge-shine-strike {
    0% {
      left: -180%;
      opacity: 0;
    }
    20% {
      opacity: 1;
    }
    80% {
      opacity: 0.9;
    }
    100% {
      left: 180%;
      opacity: 0;
    }
  }

  /* æ ‡é¢˜å¼ºåŠ¿å‡ºåœº */
  :global(.hero-cute-anime) .hero-banner-wrapper .absolute {
    animation: chitoge-title-pop 1.3s cubic-bezier(0.34, 1.56, 0.64, 1) 0.7s both;
  }

  @keyframes chitoge-title-pop {
    0% {
      opacity: 0;
      transform: translateY(30px) scale(0.88);
    }
    55% {
      transform: translateY(-4px) scale(1.03);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* æ˜äº®é«˜å…‰ç‚¹ç¼€ - æ‚¬åœæ—¶æ‰æ˜¾ç° */
  :global(.hero-cute-anime) .hero-banner-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
      radial-gradient(circle at 35% 25%, rgba(245, 158, 11, 0.08) 0%, transparent 35%),
      radial-gradient(circle at 65% 75%, rgba(251, 191, 36, 0.06) 0%, transparent 40%);
    animation: chitoge-sparkle 3.5s ease-in-out infinite;
    pointer-events: none;
    opacity: 0;
    z-index: 1;
  }

  :global(.hero-cute-anime) .hero-banner-wrapper:hover::before {
    opacity: 1;
    transition: opacity 0.5s ease-out;
  }

  @keyframes chitoge-sparkle {
    0%, 100% { opacity: 0.4; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
  }

  /* ============================================
     ğŸ“± å“åº”å¼ & æ— éšœç¢
     ============================================ */

  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation: none !important;
      transition: none !important;
    }
    :global(.hero-cool-anime) .hero-banner-image,
    :global(.hero-cute-anime) .hero-banner-image {
      filter: none !important;
      opacity: 1 !important;
      transform: none !important;
    }
  }

  @media (max-width: 768px) {
    :global(.hero-cool-anime) .hero-banner-image {
      animation: rikka-awaken 1.5s ease-out forwards;
    }
    :global(.hero-cute-anime) .hero-banner-image {
      animation: chitoge-burst-in 1.2s ease-out forwards;
    }
    .hero-banner-wrapper:hover .hero-banner-image {
      transform: none !important;
    }
  }
</style>
