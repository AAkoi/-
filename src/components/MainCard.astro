---
import { t } from "@config";
import { Icon } from "astro-icon/components";
import Card from "@/components/temple/Card.astro";
import { Image } from "astro:assets";
import type { PostData } from "@interfaces/data";

export interface MainCardProps extends PostData {
  infoIcon?: string; // Icon for the info button
  helpText?: string; // Custom help text (defaults to "Learn More")
  textOverlay?: string; // Text to overlay on background when no image
  showTextBackground?: boolean; // Show text background when no image
  headerClass?: string; // Additional classes for the header
  extraClasses?: string; // Additional classes for the whole card
}

const {
  title,
  description,
  image,
  infoIcon = "lucide:help-circle",
  helpText = t("label.learnMore"),
  textOverlay,
  showTextBackground = true,
  headerClass = "",
  extraClasses = "",
} = Astro.props as MainCardProps;

// Create a more descriptive label for the button
const accessibleHelpText = `${helpText}: ${title}`;
---

<Card class={`overflow-hidden ${extraClasses}`}>
  {
    image ? (
      // With image - show image with overlay title
      <div class="relative hero-banner-wrapper">
        <div class="aspect-video w-full overflow-hidden bg-base-300">
          <Image
            src={image}
            alt={title}
            width={1200}
            height={630}
            format="webp"
            loading="eager"
            class="w-full h-full object-contain hero-banner-image"
          />
        </div>

        {/* Flex container for Title and Button */}
        <div class="absolute bottom-4 left-4 right-4 lg:bottom-6 lg:left-6 lg:right-6 flex items-end justify-between gap-4">
          {/* Title */}
          <div class="inline-block bg-black/60 backdrop-blur-md px-4 py-2 rounded-xl border border-white/40 shadow-lg">
            <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold text-white">{title}</h1>
          </div>

          {/* Description Button */}
          {description && (
            <div class="flex-shrink-0">
              <div class="dropdown dropdown-top dropdown-end dropdown-hover">
                <label
                  tabindex="0"
                  aria-label={accessibleHelpText}
                  class="group btn btn-sm px-2 bg-black/60 backdrop-blur-md hover:bg-black/80 border border-white/40 text-white shadow-lg rounded-full flex items-center gap-0 transition-all duration-300 ease-in-out"
                >
                  <Icon name={infoIcon} class="w-4 h-4 flex-shrink-0" />
                  <span class="w-0 overflow-hidden group-hover:w-20 transition-all duration-300 text-xs whitespace-nowrap">
                    {helpText}
                  </span>
                </label>
                <div
                  tabindex="0"
                  class="dropdown-content z-[1] card w-64 sm:w-80 p-2 shadow-lg bg-black/70 backdrop-blur-md text-white border border-white/20 mb-4"
                  data-state="closed"
                >
                  <div class="card-body p-3">
                    <p class="text-sm">{description}</p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    ) : textOverlay ? (
      // No image, but with textOverlay - show gradient background with overlay text
      <div class="relative">
        <div class={`aspect-video w-full overflow-hidden bg-gradient-to-br from-base-300 to-base-100 ${headerClass}`}>
          {showTextBackground && textOverlay && (
            <div class="absolute inset-0 w-full h-full error-animation-container">
              <div class="text-9xl md:text-[12rem] font-bold text-primary opacity-20 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                {textOverlay}
              </div>
            </div>
          )}
        </div>

        {/* Flex container for Title and Button */}
        <div class="absolute bottom-4 left-4 right-4 lg:bottom-6 lg:left-6 lg:right-6 flex items-end justify-between gap-4">
          {/* Title */}
          <div class="inline-block bg-black/60 backdrop-blur-md px-4 py-2 rounded-xl border border-white/40 shadow-lg">
            <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold text-white">{title}</h1>
          </div>

          {/* Description Button */}
          {description && (
            <div class="flex-shrink-0">
              <div class="dropdown dropdown-top dropdown-end dropdown-hover">
                <label
                  tabindex="0"
                  aria-label={accessibleHelpText}
                  class="group btn btn-sm px-2 bg-black/60 backdrop-blur-md hover:bg-black/80 border border-white/40 text-white shadow-lg rounded-full flex items-center gap-0 transition-all duration-300 ease-in-out"
                >
                  <Icon name={infoIcon} class="w-4 h-4 flex-shrink-0" />
                  <span class="w-0 overflow-hidden group-hover:w-20 transition-all duration-300 text-xs whitespace-nowrap">
                    {helpText}
                  </span>
                </label>
                <div
                  tabindex="0"
                  class="dropdown-content z-[1] card w-64 sm:w-80 p-2 shadow-lg bg-black/70 backdrop-blur-md text-white border border-white/20 mb-4"
                  data-state="closed"
                >
                  <div class="card-body p-3">
                    <p class="text-sm">{description}</p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    ) : (
      // No image, no textOverlay - show simple title and description at top
      <div class="pt-6 px-6">
        <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold">{title}</h1>
        {description && <p class="mt-2 text-sm text-base-content/80">{description}</p>}
      </div>
    )
  }

  <!-- Content section -->
  <div class="p-4 sm:p-6">
    <slot />
  </div>
</Card>

<script>
  document.addEventListener("astro:page-load", () => {
    // Get all info buttons and dropdown contents
    const infoButtons = document.querySelectorAll(".dropdown label");
    const dropdownContents = document.querySelectorAll(".dropdown-content");

    // Add click event listeners
    infoButtons.forEach((button, index) => {
      button.addEventListener("click", () => {
        const content = dropdownContents[index];
        const currentState = content.getAttribute("data-state");

        // Toggle state
        if (currentState === "closed") {
          content.setAttribute("data-state", "open");
          // Add animation classes when opening
          content.classList.add("scale-100", "opacity-100");
          content.classList.remove("scale-90", "opacity-0");
        } else {
          content.setAttribute("data-state", "closed");
          // Remove animation classes when closing
          content.classList.add("scale-90", "opacity-0");
          content.classList.remove("scale-100", "opacity-100");
        }
      });
    });
  });
</script>

<style>
  /* 炫酷登场动画 */
  @keyframes hero-zoom-in {
    0% {
      transform: scale(1.2);
      opacity: 0;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes hero-float {
    0%, 100% {
      transform: translateY(0px) scale(1);
    }
    50% {
      transform: translateY(-10px) scale(1.02);
    }
  }

  @keyframes shine-sweep {
    0% {
      transform: translateX(-100%) skewX(-15deg);
      opacity: 0;
    }
    50% {
      opacity: 1;
    }
    100% {
      transform: translateX(200%) skewX(-15deg);
      opacity: 0;
    }
  }

  /* Banner 容器动画效果 */
  .hero-banner-wrapper {
    position: relative;
    overflow: hidden;
  }

  .hero-banner-wrapper::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.3) 50%,
      transparent 100%
    );
    animation: shine-sweep 3s ease-in-out 0.5s 1;
    pointer-events: none;
  }

  /* 背景图片动画 */
  .hero-banner-image {
    animation: hero-zoom-in 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    will-change: transform, opacity;
  }

  /* 默认移除通用悬停效果，由各自的风格类控制 */
  .hero-banner-wrapper {
    transition: all 0.3s ease-out;
  }

  /* 标题容器动画 */
  .hero-banner-wrapper .absolute {
    animation: fadeInUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
  }

  @keyframes fadeInUp {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* 耍酷风格 - 首页动画（小鸟游六花气质：冷酷中二、邪王真眼、结界静默感） */
  .hero-cool-anime .hero-banner-image {
    animation: hero-zoom-in 1.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    filter: brightness(0.85) contrast(1.1);
  }

  /* 悬停时：邪王真眼觉醒 - 缓慢脉动，不突兀 */
  .hero-cool-anime:hover .hero-banner-image {
    animation: hero-eye-pulse 6s ease-in-out infinite;
    filter: brightness(0.95) contrast(1.15) saturate(1.2);
    transition: filter 1.2s ease-out;
  }

  @keyframes hero-eye-pulse {
    0%, 100% {
      transform: scale(1);
      filter: brightness(0.95) contrast(1.15);
    }
    50% {
      transform: scale(1.01);
      filter: brightness(1.02) contrast(1.18) saturate(1.3);
    }
  }

  /* 结界光效：冷色霓虹微光 */
  .hero-cool-anime .hero-banner-wrapper::after {
    background: linear-gradient(
      135deg,
      transparent 0%,
      rgba(59, 130, 246, 0.15) 30%,
      rgba(139, 92, 246, 0.25) 50%,
      rgba(236, 72, 153, 0.2) 70%,
      transparent 100%
    );
    animation: mystic-barrier 4s ease-in-out 0.8s 1;
    mix-blend-mode: screen;
  }

  @keyframes mystic-barrier {
    0% {
      opacity: 0;
      transform: translateX(-100%) skewX(-15deg);
    }
    40% {
      opacity: 0.6;
    }
    100% {
      opacity: 0;
      transform: translateX(150%) skewX(-15deg);
    }
  }

  /* 甜酷风格 - 友链页动画（千棘气质：明亮锐利、阳光炸裂、甜酷反差） */
  .hero-cute-anime .hero-banner-image {
    animation: hero-zoom-in 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    filter: brightness(1.1) contrast(1.2) saturate(1.15);
  }

  /* 悬停时：活力跃动感 - 有节奏的弹跳 */
  .hero-cute-anime:hover .hero-banner-image {
    animation: hero-energy-bounce 2.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    filter: brightness(1.15) contrast(1.25) saturate(1.25);
    transition: filter 0.4s ease-out;
  }

  @keyframes hero-energy-bounce {
    0%, 100% {
      transform: scale(1) translateY(0) rotate(0deg);
    }
    15% {
      transform: scale(1.03) translateY(-8px) rotate(0.8deg);
    }
    30% {
      transform: scale(1) translateY(0) rotate(0deg);
    }
    45% {
      transform: scale(1.02) translateY(-4px) rotate(-0.5deg);
    }
    60% {
      transform: scale(1) translateY(0) rotate(0deg);
    }
  }

  /* 阳光爆发光效：明亮高能量 */
  .hero-cute-anime .hero-banner-wrapper::after {
    background: linear-gradient(
      110deg,
      transparent 0%,
      rgba(251, 191, 36, 0.45) 30%,
      rgba(249, 115, 22, 0.5) 45%,
      rgba(244, 114, 182, 0.55) 55%,
      rgba(251, 191, 36, 0.45) 70%,
      transparent 100%
    );
    animation: sunshine-blast 2.2s cubic-bezier(0.4, 0, 0.2, 1) 0.5s 1;
    mix-blend-mode: overlay;
  }

  @keyframes sunshine-blast {
    0% {
      opacity: 0;
      transform: translateX(-120%) skewX(-20deg) scale(0.8);
    }
    30% {
      opacity: 0.8;
    }
    100% {
      opacity: 0;
      transform: translateX(180%) skewX(-20deg) scale(1.2);
    }
  }

  /* 小鸟游六花：结界粒子效果 - 冷色静谧旋转 */
  .hero-cool-anime .hero-banner-wrapper::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(
      circle at 30% 40%,
      rgba(139, 92, 246, 0.08) 0%,
      transparent 40%
    ),
    radial-gradient(
      circle at 70% 60%,
      rgba(59, 130, 246, 0.06) 0%,
      transparent 45%
    );
    animation: barrier-rotate 25s linear infinite;
    pointer-events: none;
    opacity: 0;
    z-index: 1;
  }

  .hero-cool-anime:hover .hero-banner-wrapper::before {
    opacity: 1;
    transition: opacity 1.5s ease-out;
  }

  @keyframes barrier-rotate {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* 千棘：能量粒子效果 - 明亮快速闪烁 */
  .hero-cute-anime .hero-banner-wrapper::before {
    content: '';
    position: absolute;
    top: -30%;
    left: -30%;
    width: 160%;
    height: 160%;
    background: radial-gradient(
      circle at 40% 30%,
      rgba(251, 191, 36, 0.15) 0%,
      transparent 35%
    ),
    radial-gradient(
      circle at 60% 70%,
      rgba(244, 114, 182, 0.12) 0%,
      transparent 40%
    ),
    radial-gradient(
      circle at 80% 50%,
      rgba(249, 115, 22, 0.1) 0%,
      transparent 30%
    );
    animation: energy-sparkle 3s ease-in-out infinite;
    pointer-events: none;
    opacity: 0;
    z-index: 1;
  }

  .hero-cute-anime:hover .hero-banner-wrapper::before {
    opacity: 1;
    transition: opacity 0.6s ease-out;
  }

  @keyframes energy-sparkle {
    0%, 100% {
      transform: scale(1) rotate(0deg);
      opacity: 0.6;
    }
    50% {
      transform: scale(1.15) rotate(180deg);
      opacity: 1;
    }
  }

  /* 小鸟游六花：扫描线结界效果 */
  .hero-cool-anime .hero-banner-wrapper {
    position: relative;
  }

  .hero-cool-anime .hero-banner-wrapper .aspect-video::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(139, 92, 246, 0.03) 2px,
      rgba(139, 92, 246, 0.03) 4px
    );
    pointer-events: none;
    opacity: 0;
    transition: opacity 1s ease-out;
    z-index: 2;
  }

  .hero-cool-anime:hover .hero-banner-wrapper .aspect-video::after {
    opacity: 1;
  }

  /* 千棘：锐利光束效果 */
  .hero-cute-anime .hero-banner-wrapper .aspect-video::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      linear-gradient(45deg, transparent 48%, rgba(251, 191, 36, 0.15) 49%, rgba(251, 191, 36, 0.15) 51%, transparent 52%),
      linear-gradient(-45deg, transparent 48%, rgba(244, 114, 182, 0.12) 49%, rgba(244, 114, 182, 0.12) 51%, transparent 52%);
    background-size: 200% 200%;
    background-position: -100% -100%;
    pointer-events: none;
    opacity: 0;
    transition: all 0.5s ease-out;
    z-index: 2;
  }

  .hero-cute-anime:hover .hero-banner-wrapper .aspect-video::after {
    opacity: 1;
    background-position: 100% 100%;
    transition: all 2s ease-out;
  }

  /* 响应式优化 - 移动端减少动画 */
  @media (prefers-reduced-motion: reduce) {
    .hero-banner-image,
    .hero-banner-wrapper::after,
    .hero-banner-wrapper::before,
    .hero-banner-wrapper .absolute {
      animation: none !important;
    }
  }

  @media (max-width: 768px) {
    /* 移动端简化动画 */
    .hero-cool-anime .hero-banner-image {
      animation: hero-zoom-in 1.2s ease-out forwards;
      filter: brightness(0.9) contrast(1.1);
    }
    
    .hero-cute-anime .hero-banner-image {
      animation: hero-zoom-in 0.9s ease-out forwards;
      filter: brightness(1.05) contrast(1.15);
    }

    /* 移动端禁用悬停动画 */
    .hero-cool-anime:hover .hero-banner-image,
    .hero-cute-anime:hover .hero-banner-image {
      animation: none;
    }

    .hero-cool-anime:hover .hero-banner-wrapper::before,
    .hero-cute-anime:hover .hero-banner-wrapper::before {
      opacity: 0;
    }
  }
</style>
